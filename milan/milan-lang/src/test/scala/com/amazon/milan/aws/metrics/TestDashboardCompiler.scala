package com.amazon.milan.aws.metrics

import org.junit.Assert._
import org.junit.Test


@Test
class TestDashboardCompiler {
  @Test
  def testCompile(): Unit = {
    val template = DashboardCompiler.compile(
      "applicationInstanceId",
      List(
        CompiledMetric("meterName", "meterOp", "Meter"),
        CompiledMetric("counterName", "counterOp", "Counter")),
      List("ip-worker-1", "ip-worker-2"), 3, "eu-west-1", "Milan", "ip-master")

    val expectedTemplate = "{\n  \"AWSTemplateFormatVersion\": \"2010-09-09\",\n  \"Resources\": {\n    \"Dashboard\": {\n      \"Type\": \"AWS::CloudWatch::Dashboard\",\n      \"Properties\": {\n        \"DashboardName\": \"milan-dashboard-applicationInstanceId\",\n        \"DashboardBody\": \"{\n  \\\"widgets\\\": [\n\n    {\n  \\\"type\\\": \\\"text\\\",\n  \\\"width\\\": 6,\n  \\\"height\\\": 6,\n  \\\"properties\\\": {\n    \\\"markdown\\\": \\\"This dashboard was created for Milan using CloudFormation and should not be changed in the console.\\\"\n  }\n},\n{\n  \\\"type\\\": \\\"metric\\\",\n  \\\"x\\\": 0,\n  \\\"y\\\": 0,\n  \\\"width\\\": 6,\n  \\\"height\\\": 6,\n  \\\"properties\\\": {\n    \\\"metrics\\\": [\n      [ \\\"Milan\\\", \\\"ip-worker-1_applicationInstanceId_meterOp_0_meterName_rate\\\", \\\"host\\\", \\\"ip-master\\\", \\\"metric_type\\\", \\\"gauge\\\", { \\\"label\\\": \\\"p50\\\", \\\"stat\\\": \\\"p50\\\" } ],\n      [ \\\"...\\\", { \\\"stat\\\": \\\"p90\\\", \\\"label\\\": \\\"p90\\\" } ],\n      [ \\\"...\\\", { \\\"label\\\": \\\"p99\\\" } ]\n    ],\n    \\\"view\\\": \\\"timeSeries\\\",\n    \\\"stacked\\\": false,\n    \\\"region\\\": \\\"eu-west-1\\\",\n    \\\"liveData\\\": false,\n    \\\"stat\\\": \\\"p99\\\",\n    \\\"period\\\": 300,\n    \\\"title\\\": \\\"ip-worker-1_meterOp_0_meterName_rate\\\",\n    \\\"yAxis\\\": {\n      \\\"left\\\": {\n        \\\"showUnits\\\": false,\n        \\\"label\\\": \\\"Events/second\\\"\n      },\n      \\\"right\\\": {\n        \\\"label\\\": \\\"\\\"\n      }\n    }\n  }\n},\n{\n  \\\"type\\\": \\\"metric\\\",\n  \\\"x\\\": 0,\n  \\\"y\\\": 0,\n  \\\"width\\\": 6,\n  \\\"height\\\": 6,\n  \\\"properties\\\": {\n    \\\"metrics\\\": [\n      [ \\\"Milan\\\", \\\"ip-worker-2_applicationInstanceId_meterOp_0_meterName_rate\\\", \\\"host\\\", \\\"ip-master\\\", \\\"metric_type\\\", \\\"gauge\\\", { \\\"label\\\": \\\"p50\\\", \\\"stat\\\": \\\"p50\\\" } ],\n      [ \\\"...\\\", { \\\"stat\\\": \\\"p90\\\", \\\"label\\\": \\\"p90\\\" } ],\n      [ \\\"...\\\", { \\\"label\\\": \\\"p99\\\" } ]\n    ],\n    \\\"view\\\": \\\"timeSeries\\\",\n    \\\"stacked\\\": false,\n    \\\"region\\\": \\\"eu-west-1\\\",\n    \\\"liveData\\\": false,\n    \\\"stat\\\": \\\"p99\\\",\n    \\\"period\\\": 300,\n    \\\"title\\\": \\\"ip-worker-2_meterOp_0_meterName_rate\\\",\n    \\\"yAxis\\\": {\n      \\\"left\\\": {\n        \\\"showUnits\\\": false,\n        \\\"label\\\": \\\"Events/second\\\"\n      },\n      \\\"right\\\": {\n        \\\"label\\\": \\\"\\\"\n      }\n    }\n  }\n},\n{\n  \\\"type\\\": \\\"metric\\\",\n  \\\"x\\\": 0,\n  \\\"y\\\": 0,\n  \\\"width\\\": 6,\n  \\\"height\\\": 6,\n  \\\"properties\\\": {\n    \\\"metrics\\\": [\n      [ \\\"Milan\\\", \\\"ip-worker-1_applicationInstanceId_counterOp_0_counterName\\\", \\\"host\\\", \\\"ip-master\\\", \\\"metric_type\\\", \\\"gauge\\\", { \\\"label\\\": \\\"p50\\\", \\\"stat\\\": \\\"p50\\\" } ],\n      [ \\\"...\\\", { \\\"stat\\\": \\\"p90\\\", \\\"label\\\": \\\"p90\\\" } ],\n      [ \\\"...\\\", { \\\"label\\\": \\\"p99\\\" } ]\n    ],\n    \\\"view\\\": \\\"timeSeries\\\",\n    \\\"stacked\\\": false,\n    \\\"region\\\": \\\"eu-west-1\\\",\n    \\\"liveData\\\": false,\n    \\\"stat\\\": \\\"p99\\\",\n    \\\"period\\\": 300,\n    \\\"title\\\": \\\"ip-worker-1_counterOp_0_counterName\\\",\n    \\\"yAxis\\\": {\n      \\\"left\\\": {\n        \\\"showUnits\\\": false,\n        \\\"label\\\": \\\"Count\\\"\n      },\n      \\\"right\\\": {\n        \\\"label\\\": \\\"\\\"\n      }\n    }\n  }\n},\n{\n  \\\"type\\\": \\\"metric\\\",\n  \\\"x\\\": 0,\n  \\\"y\\\": 0,\n  \\\"width\\\": 6,\n  \\\"height\\\": 6,\n  \\\"properties\\\": {\n    \\\"metrics\\\": [\n      [ \\\"Milan\\\", \\\"ip-worker-2_applicationInstanceId_counterOp_0_counterName\\\", \\\"host\\\", \\\"ip-master\\\", \\\"metric_type\\\", \\\"gauge\\\", { \\\"label\\\": \\\"p50\\\", \\\"stat\\\": \\\"p50\\\" } ],\n      [ \\\"...\\\", { \\\"stat\\\": \\\"p90\\\", \\\"label\\\": \\\"p90\\\" } ],\n      [ \\\"...\\\", { \\\"label\\\": \\\"p99\\\" } ]\n    ],\n    \\\"view\\\": \\\"timeSeries\\\",\n    \\\"stacked\\\": false,\n    \\\"region\\\": \\\"eu-west-1\\\",\n    \\\"liveData\\\": false,\n    \\\"stat\\\": \\\"p99\\\",\n    \\\"period\\\": 300,\n    \\\"title\\\": \\\"ip-worker-2_counterOp_0_counterName\\\",\n    \\\"yAxis\\\": {\n      \\\"left\\\": {\n        \\\"showUnits\\\": false,\n        \\\"label\\\": \\\"Count\\\"\n      },\n      \\\"right\\\": {\n        \\\"label\\\": \\\"\\\"\n      }\n    }\n  }\n}\n\n  ]\n}\"\n      }\n    }\n  }\n}"

    assertEquals(expectedTemplate, template)
  }
}
